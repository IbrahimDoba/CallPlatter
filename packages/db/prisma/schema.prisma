generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String              @id @default(cuid())
  email                String              @unique
  name                 String?
  password             String?
  image                String?
  emailVerified        DateTime?
  emailVerificationOtp String?
  otpExpiresAt         DateTime?
  role                 String              @default("USER")
  onboardingCompleted  Boolean?            @default(false)
  polarCustomerId      String?             @unique
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  businessId           String?
  accounts             Account[]
  onboardingProgress   OnboardingProgress?
  sessions             Session[]
  business             Business?           @relation(fields: [businessId], references: [id])

  @@map("users")
}

model OnboardingProgress {
  id                    String   @id @default(cuid())
  userId                String   @unique
  currentStep           Int      @default(1)
  businessName          String?
  businessDescription   String?
  selectedVoice         String?
  selectedAccent        String?
  greeting              String?
  recordingConsent      Boolean  @default(false)
  selectedPlan          String?
  trialActivated        Boolean  @default(false)
  polarCustomerId       String?
  selectedPhoneNumber   String?
  selectedPhoneNumberId String?
  transferEnabled       Boolean  @default(false)
  transferPhoneNumber   String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("onboarding_progress")
}

/// NextAuth account links (for OAuth providers)
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?    @map("expires_at")
  token_type        String? @map("token_type")
  scope             String?
  id_token          String? @map("id_token")
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

/// NextAuth email verification tokens
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

/// Email verification OTP tokens for signup verification
model EmailVerificationToken {
  id        String   @id @default(cuid())
  email     String
  otp       String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([otp])
  @@index([expiresAt])
  @@map("email_verification_tokens")
}

/// Password reset tokens for forgot password functionality
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  otp       String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([otp])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

model Business {
  id                  String               @id @default(cuid())
  name                String
  description         String?
  phoneNumber         String?
  address             String?
  website             String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  phoneNumberId       String?              @unique
  appointments        Appointment[]
  billingTransactions BillingTransaction[]
  billingUsage        BillingUsage[]
  businessMemories    BusinessMemory[]
  calls               Call[]
  conversations       Conversation[]
  crmImports          CRMImport[]
  elevenLabsAgent     ElevenLabsAgent?
  phoneNumberRecord   PhoneNumber?
  subscription        Subscription?
  tools               Tool[]
  users               User[]

  @@map("businesses")
}

model PhoneNumber {
  id                String    @id @default(cuid())
  number            String    @unique
  countryCode       String
  isActive          Boolean   @default(true)
  isAssigned        Boolean   @default(false)
  assignedTo        String?   @unique
  twilioSid         String?   @unique
  twilioPhoneNumber String?
  webhookUrl        String?
  capabilities      Json?
  purchaseDate      DateTime?
  monthlyCost       Decimal?  @db.Decimal(10, 2)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  business          Business? @relation(fields: [assignedTo], references: [id])

  @@index([isAssigned])
  @@index([isActive])
  @@index([assignedTo])
  @@index([twilioSid])
  @@map("phone_numbers")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Call {
  id              String              @id @default(cuid())
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  customerAddress String?
  transcript      String?
  summary         String?
  intent          String?
  callType        String?             @default("WEB")
  status          CallStatus          @default(INCOMING)
  duration        Int?
  durationMinutes Decimal?            @db.Decimal(10, 2)
  audioFileUrl    String?
  businessId      String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  twilioCallSid   String?
  logs            CallLog[]
  business        Business            @relation(fields: [businessId], references: [id])
  crmEnhancement  CRMCallEnhancement?

  @@map("calls")
}

model CallLog {
  id         String   @id @default(cuid())
  callId     String
  message    String
  sender     String
  timestamp  DateTime @default(now())
  audioChunk String?
  metadata   Json?
  call       Call     @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@index([callId])
  @@map("call_logs")
}

model Appointment {
  id              String            @id @default(cuid())
  customerName    String
  customerPhone   String
  customerEmail   String?
  appointmentTime DateTime
  service         String?
  notes           String?
  status          AppointmentStatus @default(PENDING)
  businessId      String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  business        Business          @relation(fields: [businessId], references: [id])

  @@map("appointments")
}

model Conversation {
  id         String    @id @default(cuid())
  customerId String?
  businessId String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  business   Business  @relation(fields: [businessId], references: [id])
  messages   Message[]

  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  content        String
  role           String
  conversationId String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

/// Stores business-specific memory/context information
model BusinessMemory {
  id         String   @id @default(cuid())
  title      String
  content    String
  isActive   Boolean  @default(true)
  businessId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  business   Business @relation(fields: [businessId], references: [id])

  @@map("business_memory")
}

/// Simple CRM import tracking - Pinecone handles the actual data
model CRMImport {
  id                String          @id @default(cuid())
  businessId        String
  fileName          String
  status            CRMImportStatus @default(PENDING)
  recordsProcessed  Int?
  phoneNumbersFound Int?
  errorMessage      String?
  pineconeNamespace String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  business          Business        @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([status])
  @@map("crm_imports")
}

/// Optional: Track CRM-enhanced calls for analytics
model CRMCallEnhancement {
  id              String   @id @default(cuid())
  callId          String   @unique
  customerFound   Boolean  @default(false)
  customerName    String?
  similarityScore Float?
  enhancedAt      DateTime @default(now())
  call            Call     @relation(fields: [callId], references: [id])

  @@index([callId])
  @@map("crm_call_enhancements")
}

/// ElevenLabs Agent configuration for businesses
/// This is the single source of truth for AI agent settings
model ElevenLabsAgent {
  id                  String      @id @default(cuid())
  businessId          String      @unique
  agentId             String
  voiceId             String
  voiceName           String
  configHash          String?
  isActive            Boolean     @default(true)
  firstMessage        String?
  goodbyeMessage      String?
  systemPrompt        String?
  temperature         Float?
  askForName          Boolean     @default(true)
  askForPhone         Boolean     @default(true)
  askForEmail         Boolean     @default(true)
  askForCompany       Boolean     @default(false)
  askForAddress       Boolean     @default(false)
  settings            Json?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  transferEnabled     Boolean     @default(false)
  transferPhoneNumber String?
  tools               AgentTool[]
  business            Business    @relation(fields: [businessId], references: [id])

  @@map("elevenlabs_agents")
}

/// Workspace-level tools that can be created and reused across agents
/// These are created via ElevenLabs API and stored for reference
model Tool {
  id               String      @id @default(cuid())
  businessId       String
  elevenLabsToolId String      @unique
  type             ToolType
  name             String
  description      String
  config           Json
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  agentTools       AgentTool[]
  business         Business    @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, name])
  @@index([businessId])
  @@index([elevenLabsToolId])
  @@map("tools")
}

/// Junction table linking agents to tools (many-to-many)
/// Determines which tools are available to which agents
model AgentTool {
  id        String          @id @default(cuid())
  agentId   String
  toolId    String?
  isEnabled Boolean         @default(true)
  order     Int?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  agent     ElevenLabsAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  tool      Tool?           @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([agentId, toolId])
  @@index([agentId])
  @@index([toolId])
  @@map("agent_tools")
}

model Subscription {
  id                  String             @id @default(cuid())
  businessId          String             @unique
  planType            PlanType
  status              SubscriptionStatus @default(TRIAL)
  currentPeriodStart  DateTime
  currentPeriodEnd    DateTime
  minutesIncluded     Int
  minutesUsed         Int                @default(0)
  overageRate         Decimal            @db.Decimal(10, 2)
  trialEndsAt         DateTime?
  trialStartedAt      DateTime?
  trialActivated      Boolean            @default(false)
  trialPlanType       String?
  cancelledAt         DateTime?
  polarSubscriptionId String?            @unique
  polarCustomerId     String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  business            Business           @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([currentPeriodEnd])
  @@index([polarSubscriptionId])
  @@index([polarCustomerId])
  @@map("subscriptions")
}

model BillingUsage {
  id              String   @id @default(cuid())
  businessId      String
  month           Int
  year            Int
  totalMinutes    Decimal  @default(0) @db.Decimal(10, 2)
  includedMinutes Int
  overageMinutes  Decimal  @default(0) @db.Decimal(10, 2)
  overageCost     Decimal  @default(0) @db.Decimal(10, 2)
  totalCost       Decimal  @default(0) @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, month, year])
  @@index([businessId])
  @@index([month, year])
  @@index([businessId, year, month])
  @@map("billing_usage")
}

model BillingTransaction {
  id          String          @id @default(cuid())
  businessId  String
  type        TransactionType
  amount      Decimal         @db.Decimal(10, 2)
  description String
  month       Int?
  year        Int?
  status      PaymentStatus   @default(PENDING)
  paidAt      DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  business    Business        @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([createdAt])
  @@index([businessId, month, year])
  @@index([type])
  @@map("billing_transactions")
}

model DemoRequest {
  id             String            @id @default(cuid())
  firstName      String
  email          String
  companyName    String
  industry       String
  companySocials String?
  demoEmail      String
  status         DemoRequestStatus @default(PENDING)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
  @@map("demo_requests")
}

enum ToolType {
  webhook
  client
  system
}

enum DemoRequestStatus {
  PENDING
  CONTACTED
  DEMO_SENT
  COMPLETED
  CANCELLED
}

enum CRMImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum CallStatus {
  INCOMING
  IN_PROGRESS
  COMPLETED
  FAILED
  MISSED
  CANCELLED
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum PlanType {
  STARTER
  BUSINESS
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  CANCELLED
  PAST_DUE
  SUSPENDED
}

enum TransactionType {
  SUBSCRIPTION
  OVERAGE
  PAYMENT
  REFUND
  CREDIT
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
